<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Chat with your AI Medical Assistant - Get instant medical advice 24/7">
    <title>AI Medical Chat - Your 24/7 AI Doctor</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="../js/config.js"></script>
    <style>
        /* Sliding panel styles */
        .chat-wrapper {
            transition: width 0.3s ease, margin-right 0.3s ease;
            width: 100%;
        }

        .chat-wrapper.panel-open {
            width: 55%;
            margin-right: 45%;
        }

        .clinic-panel {
            position: fixed;
            top: 0;
            right: -45%;
            width: 45%;
            height: 100vh;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: right 0.3s ease;
            z-index: 100;
            overflow-y: auto;
        }

        .clinic-panel.open {
            right: 0;
        }

        /* Map overlay styles */
        .map-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 55%;
            height: 100vh;
            z-index: 90;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .map-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #mapContainer {
            width: 100%;
            height: 100%;
        }

        .map-info {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.4), inset 0 0 30px rgba(255, 255, 255, 0.3);
            border: 6px solid rgba(255, 255, 255, 0.2);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: #FFFFFF;
            z-index: 1000;
        }

        .mapboxgl-popup-content {
            background: hsla(0, 0%, 100%, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .popup-title {
            font-weight: 600;
            font-size: 14px;
            color: #4a90e2;
            margin-bottom: 6px;
        }

        .popup-detail {
            font-size: 12px;
            color: #718096;
            margin: 4px 0;
        }

        @media (max-width: 768px) {
            .map-overlay {
                width: 100%;
            }
            .chat-wrapper.panel-open {
                width: 0;
                overflow: hidden;
            }

            .clinic-panel {
                right: -100%;
                width: 100%;
            }

            .clinic-panel.open {
                right: 0;
            }
        }
    </style>
</head>
<body class="relative overflow-x-hidden">

    <!-- Header -->
    <header class="glass-morphism-strong sticky top-0 z-50 border-b border-white/20">
        <div class="container-custom">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center gap-3">
                    <div class="logo w-10 h-10 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="font-headline font-bold text-primary text-xl">AI Medical Assistant</div>
                        <div class="text-xs text-success flex items-center gap-1">
                            <span class="w-2 h-2 bg-success rounded-full animate-pulse"></span>
                            Online now
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="openClinicFinderBtn" class="btn btn-primary text-sm px-4 py-2">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Find Nearby Clinics
                    </button>
                    <a href="landing_page.html" class="btn btn-outline text-sm px-4 py-2">
                        Back to Home
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Wrapper (shrinks when panel is open) -->
    <div id="chatWrapper" class="chat-wrapper">
        <!-- Main Chat Container -->
        <main class="container-custom py-8">
            <!-- Welcome Card -->
            <div id="welcomeCard" class="card-elevated mb-6 text-center">
                <div class="mb-4">
                    <div class="w-16 h-16 rounded-full bg-accent-100 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-accent" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-headline font-bold text-primary mb-2">Welcome to Your AI Medical Assistant</h2>
                    <p class="text-text-secondary max-w-2xl mx-auto">
                        I'm here to help with your health questions 24/7. You can ask about symptoms, medications, general health advice, and more.
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-4 mt-6">
                    <button class="suggestion-btn p-4 border-2 border-border rounded-lg hover:border-accent hover:bg-accent-50 transition-all duration-base text-left">
                        <div class="font-semibold text-primary mb-1">Common Symptoms</div>
                        <div class="text-sm text-text-secondary">Ask about headaches, fatigue, fever</div>
                    </button>
                    <button class="suggestion-btn p-4 border-2 border-border rounded-lg hover:border-accent hover:bg-accent-50 transition-all duration-base text-left">
                        <div class="font-semibold text-primary mb-1">Medication Info</div>
                        <div class="text-sm text-text-secondary">Learn about drug interactions</div>
                    </button>
                    <button class="suggestion-btn p-4 border-2 border-border rounded-lg hover:border-accent hover:bg-accent-50 transition-all duration-base text-left">
                        <div class="font-semibold text-primary mb-1">Health Guidance</div>
                        <div class="text-sm text-text-secondary">Get wellness tips and advice</div>
                    </button>
                </div>
            </div>

            <!-- Chat Messages Container -->
            <div id="chatContainer" class="card-elevated mb-6" style="min-height: 500px; max-height: 600px; overflow-y: auto;">
                <div id="messagesList" class="space-y-4">
                    <!-- Messages will be inserted here -->
                </div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="hidden mt-4">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full glass-morphism flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-accent" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                            </svg>
                        </div>
                        <div class="chat-bubble chat-bubble-ai">
                            <div class="flex gap-1">
                                <span class="w-2 h-2 bg-accent rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                                <span class="w-2 h-2 bg-accent rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                                <span class="w-2 h-2 bg-accent rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden mb-6 p-4 bg-error-50 border-2 border-error rounded-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-error flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/>
                    </svg>
                    <div>
                        <div class="font-semibold text-error-700">Error</div>
                        <div id="errorText" class="text-sm text-error-700"></div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="card-elevated">
                <form id="chatForm" class="flex gap-3">
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Type your medical question..."
                        class="chat-input flex-1"
                        autocomplete="off"
                        required
                    />
                    <button type="submit" class="btn btn-primary px-6" id="sendButton">
                        <span id="sendButtonText">Send</span>
                        <svg id="sendIcon" class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>
                <div class="mt-3 text-xs text-text-tertiary text-center">
                    <strong>Disclaimer:</strong> This AI provides general health information only. For medical emergencies, call 911. Always consult a healthcare professional for diagnosis and treatment.
                </div>
            </div>
        </main>

    <!-- Clinic Finder Side Panel -->
    <div id="clinicFinderModal" class="clinic-panel">
        <!-- Panel Header -->
        <div class="sticky top-0 glass-morphism-strong border-b border-white/20 px-6 py-4 flex items-center justify-between z-10">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <h2 class="text-2xl font-headline font-bold text-primary">Clinic Finder with Pricing</h2>
            </div>
            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Panel Body -->
        <div class="p-6">
            <p class="text-text-secondary mb-6">
                Find nearby medical clinics with pricing information for your treatment needs.
            </p>

            <!-- Search Form -->
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-primary mb-2">
                                Location *
                            </label>
                            <input
                                type="text"
                                id="clinicLocation"
                                placeholder="e.g., New York, NY or 10001 or London, UK"
                                class="form-input w-full"
                            />
                        </div>

                <div>
                    <label class="block text-sm font-semibold text-primary mb-2">
                                Diagnosis / Treatment Type (Optional)
                            </label>
                            <input
                                type="text"
                                id="clinicDiagnosis"
                                placeholder="e.g., dermatology, cardiology, urgent care"
                                class="form-input w-full"
                            />
                        </div>
                    </div>

                    <button
                        id="findClinicsBtn"
                        class="btn btn-primary w-full flex items-center justify-center gap-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <span id="findClinicsText">Find Clinics with Prices</span>
                    </button>

                    <!-- Error Message -->
                    <div id="clinicError" class="hidden mt-4 p-4 bg-error-50 border-2 border-error rounded-lg">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-error flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/>
                            </svg>
                            <p id="clinicErrorText" class="text-error-700"></p>
                        </div>
                    </div>

                    <!-- Results Container -->
                    <div id="clinicResults" class="hidden mt-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="resultsTitle" class="text-xl font-bold text-primary">
                                Found Clinics
                            </h3>
                            <div class="text-sm text-text-tertiary">
                                Sorted by price (lowest first)
                            </div>
                        </div>

                        <div id="clinicsList" class="space-y-4">
                            <!-- Clinic cards will be inserted here -->
                        </div>

                        <div class="mt-6 p-4 glass-morphism rounded-lg border border-white/20">
                            <p class="text-sm text-text-secondary">
                                <strong class="text-primary">Next Steps:</strong> Use these clinic addresses with the Google Maps API
                                to calculate travel times. You can also compare these prices with international
                                options to determine if medical tourism is cost-effective.
                            </p>
                        </div>
                    </div>
            </div>

            <!-- Panel Footer -->
            <div class="sticky bottom-0 glass-morphism border-t border-white/20 px-6 py-4">
                <p class="text-xs text-text-tertiary text-center">
                    Prices are fetched from web search or estimated based on facility type and location.
                    <br />Always verify pricing directly with the healthcare provider.
                </p>
            </div>
        </div>
    </div>
    <!-- End Clinic Finder Panel -->

    <!-- Map Overlay -->
    <div id="mapOverlay" class="map-overlay">
        <div id="mapContainer"></div>
        <div id="mapInfo" class="map-info" style="display: none;">
            Click markers for clinic details
        </div>
    </div>
    <!-- End Map Overlay -->

        <!-- Footer -->
        <footer class="glass-morphism-strong border-t border-white/20 mt-12 py-8">
            <div class="container-custom">
                <div class="text-center text-text-secondary text-sm">
                    <p>&copy; 2024 AI Medical Assistant. This is not a substitute for professional medical advice.</p>
                </div>
            </div>
        </footer>
    </div>
    <!-- End Chat Wrapper -->

    <script>
        // Configuration
        const API_ENDPOINT = '/api/chat'; // Update this to your actual API endpoint

        // State
        let conversationHistory = [];

        // DOM Elements
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const messagesList = document.getElementById('messagesList');
        const typingIndicator = document.getElementById('typingIndicator');
        const sendButton = document.getElementById('sendButton');
        const sendButtonText = document.getElementById('sendButtonText');
        const sendIcon = document.getElementById('sendIcon');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const welcomeCard = document.getElementById('welcomeCard');
        const chatContainer = document.getElementById('chatContainer');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Focus input
            messageInput.focus();

            // Add suggestion button handlers
            document.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const text = this.querySelector('.text-sm').textContent;
                    messageInput.value = text;
                    messageInput.focus();
                });
            });
        });

        // Handle form submission
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const message = messageInput.value.trim();
            if (!message) return;

            // Hide welcome card on first message
            if (conversationHistory.length === 0) {
                welcomeCard.style.display = 'none';
            }

            // Clear input
            messageInput.value = '';

            // Add user message to UI
            addMessage(message, 'user');

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });

            // Show typing indicator
            showTypingIndicator();

            // Disable send button
            setSendButtonState(true);

            // Hide error if visible
            hideError();

            try {
                // Make API call
                const response = await sendMessageToAPI(message);

                // Hide typing indicator
                hideTypingIndicator();

                // Add AI response to UI
                addMessage(response, 'assistant');

                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });

            } catch (error) {
                hideTypingIndicator();
                showError(error.message);
            } finally {
                setSendButtonState(false);
                messageInput.focus();
            }
        });

        // Send message to API
        async function sendMessageToAPI(message) {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                return data.response || data.message || 'I apologize, but I received an empty response. Please try again.';

            } catch (error) {
                // If API endpoint doesn't exist, show a helpful error with mock response
                if (error.message.includes('Failed to fetch') || error.message.includes('404')) {
                    console.error('API endpoint not configured. Using mock response.');
                    // Return a mock response for demonstration
                    return getMockResponse(message);
                }
                throw error;
            }
        }

        // Mock response for when API is not available (for demonstration)
        function getMockResponse(message) {
            const lowerMessage = message.toLowerCase();

            if (lowerMessage.includes('headache') || lowerMessage.includes('head')) {
                return "I understand you're experiencing headaches. Headaches can have many causes including:\n\n‚Ä¢ Tension or stress\n‚Ä¢ Dehydration\n‚Ä¢ Eye strain\n‚Ä¢ Lack of sleep\n‚Ä¢ Certain foods or medications\n\nFor relief, you might try:\n‚Ä¢ Drinking plenty of water\n‚Ä¢ Resting in a quiet, dark room\n‚Ä¢ Applying a cold compress\n‚Ä¢ Taking over-the-counter pain relief (as directed)\n\nIf headaches are severe, persistent, or accompanied by other symptoms like vision changes, fever, or neck stiffness, please consult a healthcare provider immediately.";
            } else if (lowerMessage.includes('fever') || lowerMessage.includes('temperature')) {
                return "A fever is generally defined as a body temperature above 100.4¬∞F (38¬∞C). Common causes include:\n\n‚Ä¢ Viral or bacterial infections\n‚Ä¢ Inflammatory conditions\n‚Ä¢ Heat exhaustion\n‚Ä¢ Certain medications\n\nRecommendations:\n‚Ä¢ Stay hydrated with plenty of fluids\n‚Ä¢ Rest\n‚Ä¢ Use fever reducers like acetaminophen or ibuprofen (as directed)\n‚Ä¢ Dress in light clothing\n\nSeek immediate medical attention if fever is:\n‚Ä¢ Above 103¬∞F (39.4¬∞C)\n‚Ä¢ Lasting more than 3 days\n‚Ä¢ Accompanied by severe symptoms like difficulty breathing, chest pain, or confusion";
            } else if (lowerMessage.includes('fatigue') || lowerMessage.includes('tired')) {
                return "Chronic fatigue can stem from various factors:\n\n‚Ä¢ Insufficient sleep or poor sleep quality\n‚Ä¢ Anemia or nutritional deficiencies\n‚Ä¢ Thyroid problems\n‚Ä¢ Depression or anxiety\n‚Ä¢ Chronic conditions like diabetes or heart disease\n\nSteps to address fatigue:\n‚Ä¢ Maintain a regular sleep schedule (7-9 hours)\n‚Ä¢ Exercise regularly\n‚Ä¢ Eat a balanced diet\n‚Ä¢ Manage stress\n‚Ä¢ Limit caffeine and alcohol\n\nIf fatigue persists despite lifestyle changes, consider getting blood work done to check for underlying conditions.";
            } else {
                return `Thank you for your question. While I can provide general health information, I recommend consulting with a healthcare professional for personalized medical advice about: "${message}"\n\nIn the meantime, here are some general tips:\n‚Ä¢ Keep track of your symptoms (when they started, severity, triggers)\n‚Ä¢ Stay hydrated and maintain a healthy diet\n‚Ä¢ Get adequate rest\n‚Ä¢ Avoid self-diagnosis and self-medication without professional guidance\n\nIs there anything specific about your symptoms or concerns you'd like to discuss?`;
            }
        }

        // Add message to chat UI
        function addMessage(text, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'animate-fade-in';

            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-3 justify-end">
                        <div class="chat-bubble chat-bubble-user max-w-[80%]">
                            <p class="text-sm whitespace-pre-wrap">${escapeHtml(text)}</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-primary-600 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                            </svg>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full glass-morphism flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-accent" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                            </svg>
                        </div>
                        <div class="chat-bubble chat-bubble-ai max-w-[85%]">
                            <p class="text-sm whitespace-pre-wrap">${escapeHtml(text)}</p>
                        </div>
                    </div>
                `;
            }

            messagesList.appendChild(messageDiv);
            scrollToBottom();
        }

        // Utility functions
        function showTypingIndicator() {
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        function setSendButtonState(disabled) {
            sendButton.disabled = disabled;
            if (disabled) {
                sendButtonText.textContent = 'Sending...';
                sendButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                sendButtonText.textContent = 'Send';
                sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            scrollToBottom();
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Clear chat function (can be called from console for testing)
        function clearChat() {
            conversationHistory = [];
            messagesList.innerHTML = '';
            welcomeCard.style.display = 'block';
            hideError();
        }

        // Expose for debugging
        window.chatDebug = {
            clearChat,
            conversationHistory,
            addMessage
        };

        // ===== CLINIC FINDER MODAL =====

        const chatWrapper = document.getElementById('chatWrapper');
        const clinicFinderModal = document.getElementById('clinicFinderModal');
        const openClinicFinderBtn = document.getElementById('openClinicFinderBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const findClinicsBtn = document.getElementById('findClinicsBtn');
        const findClinicsText = document.getElementById('findClinicsText');
        const clinicLocation = document.getElementById('clinicLocation');
        const clinicDiagnosis = document.getElementById('clinicDiagnosis');
        const clinicError = document.getElementById('clinicError');
        const clinicErrorText = document.getElementById('clinicErrorText');
        const clinicResults = document.getElementById('clinicResults');
        const clinicsList = document.getElementById('clinicsList');
        const resultsTitle = document.getElementById('resultsTitle');

        let clinicsData = [];
        let isLoadingClinics = false;
        let isLoadingPrices = false;
        let userLocation = null;
        let map = null;
        let markers = [];

        const mapOverlay = document.getElementById('mapOverlay');
        const mapContainer = document.getElementById('mapContainer');
        const mapInfo = document.getElementById('mapInfo');

        // Initialize Mapbox map
        function initializeMap() {
            if (map) return; // Map already initialized

            if (!API_CONFIG.MAPBOX_API_KEY || API_CONFIG.MAPBOX_API_KEY === 'YOUR_MAPBOX_API_KEY_HERE') {
                console.error('Mapbox API key not configured');
                return;
            }

            mapboxgl.accessToken = API_CONFIG.MAPBOX_API_KEY;

            map = new mapboxgl.Map({
                container: 'mapContainer',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [-98.5795, 39.8283], // Center of US
                zoom: 4
            });

            map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        }

        // Clear all markers from map
        function clearMapMarkers() {
            markers.forEach(marker => marker.remove());
            markers = [];
        }

        // Add clinic markers to map
        function addClinicsToMap() {
            if (!map) return;

            clearMapMarkers();

            // Add user location marker if available
            if (userLocation) {
                const userMarker = document.createElement('div');
                userMarker.style.width = '30px';
                userMarker.style.height = '30px';
                userMarker.style.borderRadius = '50%';
                userMarker.style.backgroundColor = '#5ed4d9';
                userMarker.style.border = '3px solid white';
                userMarker.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';

                const marker = new mapboxgl.Marker(userMarker)
                    .setLngLat([userLocation.lng, userLocation.lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`
                        <div class="popup-title">Your Location</div>
                    `))
                    .addTo(map);

                markers.push(marker);
            }

            // Add clinic markers
            const bounds = new mapboxgl.LngLatBounds();
            let hasValidCoords = false;

            clinicsData.forEach((clinic, index) => {
                if (!clinic.coords) return;

                const el = document.createElement('div');
                el.style.width = '24px';
                el.style.height = '24px';
                el.style.borderRadius = '50%';
                el.style.backgroundColor = '#4a90e2';
                el.style.border = '3px solid white';
                el.style.cursor = 'pointer';
                el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';

                const popupHtml = `
                    <div class="popup-title">${escapeHtml(clinic.name)}</div>
                    <div class="popup-detail">üìç ${escapeHtml(clinic.address)}</div>
                    ${clinic.phone ? `<div class="popup-detail">üìû ${escapeHtml(clinic.phone)}</div>` : ''}
                    ${clinic.distance && clinic.duration ? `
                        <div class="popup-detail">üìè ${formatDistance(clinic.distance)} ‚Ä¢ ‚è±Ô∏è ${formatDuration(clinic.duration)}</div>
                    ` : ''}
                    ${clinic.price ? `<div class="popup-detail">üí∞ $${clinic.price}</div>` : ''}
                    ${clinic.type ? `<div class="popup-detail">üè• ${escapeHtml(clinic.type)}</div>` : ''}
                `;

                const marker = new mapboxgl.Marker(el)
                    .setLngLat([clinic.coords.lng, clinic.coords.lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml))
                    .addTo(map);

                markers.push(marker);
                bounds.extend([clinic.coords.lng, clinic.coords.lat]);
                hasValidCoords = true;
            });

            // Fit map to show all markers
            if (hasValidCoords) {
                if (userLocation) {
                    bounds.extend([userLocation.lng, userLocation.lat]);
                }
                map.fitBounds(bounds, {
                    padding: { top: 80, bottom: 80, left: 80, right: 80 },
                    maxZoom: 12
                });
            }

            mapInfo.style.display = markers.length > 0 ? 'block' : 'none';
        }

        // Show map overlay
        function showMap() {
            initializeMap();
            mapOverlay.classList.add('visible');
            if (map) {
                // Force map to resize to container
                setTimeout(() => {
                    map.resize();
                    addClinicsToMap();
                }, 100);
            }
        }

        // Hide map overlay
        function hideMap() {
            mapOverlay.classList.remove('visible');
        }

        // Geocoding function using Mapbox
        async function geocodeAddress(address) {
            try {
                const encodedAddress = encodeURIComponent(address);
                const response = await fetch(
                    `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodedAddress}.json?access_token=${API_CONFIG.MAPBOX_API_KEY}&limit=1`
                );
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const coords = data.features[0].center;
                    return { lng: coords[0], lat: coords[1] };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Calculate distance and duration using Mapbox Matrix API
        async function calculateDistances(originCoords, clinicCoords) {
            try {
                // Mapbox Matrix API format: lng,lat;lng,lat;...
                const coordinates = [
                    `${originCoords.lng},${originCoords.lat}`,
                    ...clinicCoords.map(c => `${c.lng},${c.lat}`)
                ].join(';');

                const response = await fetch(
                    `https://api.mapbox.com/directions-matrix/v1/mapbox/driving/${coordinates}?sources=0&annotations=distance,duration&access_token=${API_CONFIG.MAPBOX_API_KEY}`
                );
                const data = await response.json();

                if (data.distances && data.durations) {
                    // distances[0] contains distances from origin to all destinations
                    // Skip first element (distance to self)
                    return data.distances[0].slice(1).map((distance, index) => ({
                        distance: distance, // meters
                        duration: data.durations[0][index + 1] // seconds
                    }));
                }
                return [];
            } catch (error) {
                console.error('Distance calculation error:', error);
                return [];
            }
        }

        // Format distance for display
        function formatDistance(meters) {
            const miles = meters * 0.000621371;
            if (miles < 0.1) return `${Math.round(meters)} m`;
            return `${miles.toFixed(1)} mi`;
        }

        // Format duration for display
        function formatDuration(seconds) {
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `${minutes} min`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
        }

        // Panel controls
        openClinicFinderBtn.addEventListener('click', () => {
            clinicFinderModal.classList.add('open');
            chatWrapper.classList.add('panel-open');
            showMap();
        });

        closeModalBtn.addEventListener('click', closeClinicPanel);

        function closeClinicPanel() {
            clinicFinderModal.classList.remove('open');
            chatWrapper.classList.remove('panel-open');
            hideMap();
        }

        // Enter key support
        clinicLocation.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isLoadingClinics && !isLoadingPrices) {
                findClinics();
            }
        });

        clinicDiagnosis.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isLoadingClinics && !isLoadingPrices) {
                findClinics();
            }
        });

        // Find clinics button
        findClinicsBtn.addEventListener('click', findClinics);

        async function findClinics() {
            const location = clinicLocation.value.trim();

            if (!location) {
                showClinicError('Please enter a location');
                return;
            }

            isLoadingClinics = true;
            setFindButtonState('Searching for clinics...');
            hideClinicError();
            clinicResults.classList.add('hidden');
            clinicsData = [];

            try {
                const diagnosis = clinicDiagnosis.value.trim();
                const specialtyTerm = diagnosis ? `${diagnosis} specialist` : 'medical clinic';

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',
                        max_tokens: 4000,
                        temperature: 0.7,
                        messages: [{
                            role: 'system',
                            content: 'You are a helpful assistant that provides medical clinic information in JSON format. Always respond with valid JSON only, no markdown formatting.'
                        }, {
                            role: 'user',
                            content: `Find medical clinics or healthcare facilities near "${location}"${diagnosis ? ` that can treat ${diagnosis}` : ''}.

Based on your knowledge, provide a JSON array with this exact structure (no markdown, no preamble):
[
  {
    "name": "Clinic Name",
    "address": "Full street address",
    "phone": "Phone number if available",
    "type": "Type of facility (e.g., General Practice, Urgent Care, Hospital)",
    "specialty": "Relevant specialty if applicable"
  }
]

Provide at least 5-8 clinics if possible. Return ONLY the JSON array, nothing else.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                let responseText = data.choices[0].message.content;

                let cleanedText = responseText
                    .replace(/```json\n?/g, '')
                    .replace(/```\n?/g, '')
                    .trim();

                const jsonMatch = cleanedText.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    cleanedText = jsonMatch[0];
                }

                const parsedClinics = JSON.parse(cleanedText);

                if (Array.isArray(parsedClinics) && parsedClinics.length > 0) {
                    // Initialize clinics without prices
                    clinicsData = parsedClinics.map(clinic => ({
                        ...clinic,
                        price: null,
                        priceRange: null,
                        currency: 'USD',
                        distance: null,
                        duration: null
                    }));

                    displayClinics();

                    // Fetch prices for all clinics
                    await fetchPricesForClinics();

                    // Calculate distances and travel times
                    await fetchDistancesForClinics(location);
                } else {
                    showClinicError('No clinics found. Try a different location or be more specific.');
                }

            } catch (err) {
                console.error('Error finding clinics:', err);

                // Fallback to mock data for demonstration
                if (err.message.includes('API') || err.message.includes('fetch')) {
                    showClinicError('API connection failed. Showing sample data for demonstration.');
                    displayMockClinics(location);
                } else {
                    showClinicError('Failed to find clinics. Please check your location and try again.');
                }
            } finally {
                isLoadingClinics = false;
                setFindButtonState('Find Clinics with Prices');
            }
        }

        async function fetchPricesForClinics() {
            isLoadingPrices = true;
            setFindButtonState('Fetching prices...');

            try {
                const treatmentType = clinicDiagnosis.value.trim() || 'general consultation';
                const clinicNames = clinicsData.map(c => c.name).join(', ');

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',
                        max_tokens: 3000,
                        temperature: 0.7,
                        messages: [{
                            role: 'system',
                            content: 'You are a helpful assistant that provides healthcare pricing information in JSON format. Always respond with valid JSON only, no markdown formatting.'
                        }, {
                            role: 'user',
                            content: `Provide estimated consultation/treatment prices for ${treatmentType} at these clinics: ${clinicNames}

Based on typical US healthcare pricing, provide realistic estimated price ranges based on the type of facility and location.

Return ONLY a JSON array matching this structure (no markdown, no preamble):
[
  {
    "name": "Exact clinic name from the list",
    "price": 150,
    "priceRange": "100-200",
    "currency": "USD",
    "notes": "Brief note about the price (e.g., 'Initial consultation', 'Estimated range', 'With insurance')"
  }
]

Return data for ALL clinics in the same order. Generate realistic estimates based on facility type and location.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Pricing API error: ${response.status}`);
                }

                const data = await response.json();

                let responseText = data.choices[0].message.content;

                let cleanedText = responseText
                    .replace(/```json\n?/g, '')
                    .replace(/```\n?/g, '')
                    .trim();

                const jsonMatch = cleanedText.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    cleanedText = jsonMatch[0];
                }

                const pricingData = JSON.parse(cleanedText);

                // Merge pricing data with clinics
                clinicsData = clinicsData.map(clinic => {
                    const priceInfo = pricingData.find(p =>
                        p.name.toLowerCase().includes(clinic.name.toLowerCase()) ||
                        clinic.name.toLowerCase().includes(p.name.toLowerCase())
                    );

                    if (priceInfo) {
                        return {
                            ...clinic,
                            price: priceInfo.price,
                            priceRange: priceInfo.priceRange,
                            currency: priceInfo.currency || 'USD',
                            priceNotes: priceInfo.notes
                        };
                    }

                    // Fallback: generate synthetic price if no match found
                    return generateSyntheticPrice(clinic);
                });

                displayClinics();

            } catch (err) {
                console.error('Error fetching prices:', err);

                // Fallback to synthetic prices
                clinicsData = clinicsData.map(clinic => generateSyntheticPrice(clinic));
                displayClinics();
            } finally {
                isLoadingPrices = false;
                setFindButtonState('Find Clinics with Prices');
            }
        }

        function generateSyntheticPrice(clinic) {
            const basePrice = clinic.type?.toLowerCase().includes('hospital') ? 200 :
                             clinic.type?.toLowerCase().includes('urgent') ? 150 : 100;
            return {
                ...clinic,
                price: basePrice,
                priceRange: `${basePrice - 50}-${basePrice + 50}`,
                currency: 'USD',
                priceNotes: 'Estimated price (pricing data unavailable)'
            };
        }

        async function fetchDistancesForClinics(originAddress) {
            setFindButtonState('Calculating distances...');

            try {
                // Geocode the origin (user's location)
                const originCoords = await geocodeAddress(originAddress);

                if (!originCoords) {
                    console.error('Could not geocode origin address');
                    return;
                }

                userLocation = originCoords;

                // Geocode all clinic addresses
                const clinicCoords = [];
                for (const clinic of clinicsData) {
                    const coords = await geocodeAddress(clinic.address);
                    clinicCoords.push(coords);
                }

                // Filter out any failed geocoding
                const validClinics = clinicsData.filter((_, index) => clinicCoords[index] !== null);
                const validCoords = clinicCoords.filter(c => c !== null);

                if (validCoords.length === 0) {
                    console.error('Could not geocode any clinic addresses');
                    return;
                }

                // Calculate distances using Mapbox Matrix API
                const distances = await calculateDistances(originCoords, validCoords);

                // Update clinicsData with distance and duration
                let distanceIndex = 0;
                clinicsData = clinicsData.map((clinic, index) => {
                    if (clinicCoords[index] !== null && distances[distanceIndex]) {
                        const distanceData = distances[distanceIndex];
                        distanceIndex++;
                        return {
                            ...clinic,
                            distance: distanceData.distance,
                            duration: distanceData.duration,
                            coords: clinicCoords[index]
                        };
                    }
                    return clinic;
                });

                displayClinics();

                // Update map with clinic markers
                if (map && mapOverlay.classList.contains('visible')) {
                    addClinicsToMap();
                }

            } catch (error) {
                console.error('Error calculating distances:', error);
            } finally {
                setFindButtonState('Find Clinics with Prices');
            }
        }

        function displayClinics() {
            // Sort by price
            const sortedClinics = [...clinicsData].sort((a, b) => {
                if (a.price && b.price) return a.price - b.price;
                return 0;
            });

            resultsTitle.textContent = `Found ${sortedClinics.length} Clinic${sortedClinics.length !== 1 ? 's' : ''}`;

            clinicsList.innerHTML = sortedClinics.map((clinic, index) => `
                <div class="card-elevated hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-primary mb-2">${escapeHtml(clinic.name)}</h4>

                            <div class="space-y-2 text-sm text-text-secondary">
                                ${clinic.address ? `
                                <p class="flex items-start gap-2">
                                    <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    <span>${escapeHtml(clinic.address)}</span>
                                </p>
                                ` : ''}

                                ${clinic.phone ? `<p>üìû ${escapeHtml(clinic.phone)}</p>` : ''}

                                ${clinic.distance && clinic.duration ? `
                                <div class="flex items-center gap-3 mt-2">
                                    <div class="flex items-center gap-1">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                        </svg>
                                        <span class="font-medium text-primary">${formatDistance(clinic.distance)}</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span class="font-medium text-primary">${formatDuration(clinic.duration)}</span>
                                    </div>
                                </div>
                                ` : ''}

                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${clinic.type ? `
                                    <span class="inline-block px-2 py-1 bg-primary-100 text-primary-700 rounded text-xs font-medium">
                                        ${escapeHtml(clinic.type)}
                                    </span>
                                    ` : ''}

                                    ${clinic.specialty ? `
                                    <span class="inline-block px-2 py-1 bg-success-100 text-success-700 rounded text-xs font-medium">
                                        ${escapeHtml(clinic.specialty)}
                                    </span>
                                    ` : ''}
                                </div>

                                ${clinic.priceNotes ? `
                                <p class="text-xs text-text-tertiary mt-2">${escapeHtml(clinic.priceNotes)}</p>
                                ` : ''}
                            </div>
                        </div>

                        <div class="flex-shrink-0 text-right">
                            ${clinic.price ? `
                            <div class="glass-morphism border-2 border-success rounded-lg px-4 py-3">
                                <div class="flex items-center gap-1 text-success font-bold text-xl">
                                    <span>$${clinic.price}</span>
                                </div>
                                ${clinic.priceRange ? `
                                <div class="text-xs text-success-600 mt-1">
                                    Range: $${escapeHtml(clinic.priceRange)}
                                </div>
                                ` : ''}
                                <div class="text-xs text-text-tertiary mt-1">
                                    ${escapeHtml(clinic.currency)}
                                </div>
                            </div>
                            ` : `
                            <div class="glass-morphism border-2 border-border rounded-lg px-4 py-3">
                                <div class="text-sm text-text-tertiary">
                                    ${isLoadingPrices ? 'Loading...' : 'Price Loading...'}
                                </div>
                            </div>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');

            clinicResults.classList.remove('hidden');
        }

        function displayMockClinics(location) {
            // Display mock data when API is unavailable
            clinicsData = [
                {
                    name: `${location} General Medical Center`,
                    address: `123 Main St, ${location}`,
                    phone: '(555) 123-4567',
                    type: 'General Practice',
                    specialty: 'Family Medicine',
                    price: 120,
                    priceRange: '100-150',
                    currency: 'USD',
                    priceNotes: 'Initial consultation (demo data)',
                    distance: 2400, // 2.4 km in meters
                    duration: 480   // 8 minutes in seconds
                },
                {
                    name: `${location} Urgent Care`,
                    address: `456 Oak Ave, ${location}`,
                    phone: '(555) 234-5678',
                    type: 'Urgent Care',
                    specialty: 'Emergency Medicine',
                    price: 150,
                    priceRange: '120-180',
                    currency: 'USD',
                    priceNotes: 'Walk-in visit (demo data)',
                    distance: 4800, // 4.8 km in meters
                    duration: 720   // 12 minutes in seconds
                },
                {
                    name: `${location} Community Hospital`,
                    address: `789 Hospital Rd, ${location}`,
                    phone: '(555) 345-6789',
                    type: 'Hospital',
                    specialty: 'Multi-specialty',
                    price: 250,
                    priceRange: '200-300',
                    currency: 'USD',
                    priceNotes: 'ER visit (demo data)',
                    distance: 8000, // 8 km in meters
                    duration: 960   // 16 minutes in seconds
                }
            ];

            displayClinics();
        }

        function setFindButtonState(text) {
            findClinicsText.textContent = text;
            findClinicsBtn.disabled = isLoadingClinics || isLoadingPrices;

            if (findClinicsBtn.disabled) {
                findClinicsBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                findClinicsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function showClinicError(message) {
            clinicErrorText.textContent = message;
            clinicError.classList.remove('hidden');
        }

        function hideClinicError() {
            clinicError.classList.add('hidden');
        }
    </script>

</body>
</html>
